# 阿里云百炼 deepseek-v3.2 模型配置指南

## 配置文件

已为您创建配置文件：`deepseek_config.json`

```json
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "openai/deepseek-v3.2",
        "fallbacks": [
          "openai/qwen-plus",
          "openai/qwen-max"
        ]
      },
      "models": {
        "openai/deepseek-v3.2": {},
        "openai/qwen-plus": {},
        "openai/qwen-max": {},
        "openai/gpt-4o": {}
      }
    }
  },
  "models": {
    "providers": {
      "openai": {
        "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "apiKey": "sk-8e72d53f10f9450baab69f89a2e2b992"
      }
    }
  }
}
```

---

## 方法一：使用 Python 脚本注入配置（推荐）

### 1. 创建配置脚本

```bash
cat > setup_deepseek.py << 'EOF'
#!/usr/bin/env python3
import json
import os

# 配置文件路径
config_path = os.path.expanduser('~/.openclaw/openclaw.json')
env_path = os.path.expanduser('~/.openclaw/.env')

# 读取现有配置
with open(config_path, 'r') as f:
    data = json.load(f)

print('当前配置:')
print(f"主模型: {data['agents']['defaults']['model'].get('primary', '未设置')}")
print(f"备用模型: {data['agents']['defaults']['model'].get('fallbacks', [])}")

# 1. 设置主模型和备用模型
data['agents']['defaults']['model']['primary'] = 'openai/deepseek-v3.2'
data['agents']['defaults']['model']['fallbacks'] = [
    'openai/qwen-plus',
    'openai/qwen-max'
]

# 2. 定义模型映射
data['agents']['defaults']['models'] = {
    'openai/deepseek-v3.2': {},
    'openai/qwen-plus': {},
    'openai/qwen-max': {},
    'openai/gpt-4o': {}
}

# 3. 配置 openai provider（使用阿里云百炼）
if 'models' not in data:
    data['models'] = {}
if 'providers' not in data['models']:
    data['models']['providers'] = {}

data['models']['providers']['openai'] = {
    'baseUrl': 'https://dashscope.aliyuncs.com/compatible-mode/v1'
}

# 4. 禁用 qwen-portal-auth 插件（避免冲突）
if 'plugins' not in data:
    data['plugins'] = {}
if 'entries' not in data['plugins']:
    data['plugins']['entries'] = {}

data['plugins']['entries']['qwen-portal-auth'] = {'enabled': False}

# 5. 清理 qwen-portal 相关配置
if 'auth' in data and 'profiles' in data['auth']:
    keys_to_remove = [k for k in data['auth']['profiles'] if k.startswith('qwen-portal:')]
    for k in keys_to_remove:
        del data['auth']['profiles'][k]
    if keys_to_remove:
        print(f'已移除 {len(keys_to_remove)} 个 qwen-portal auth profiles')

# 6. 写入配置文件
with open(config_path, 'w') as f:
    json.dump(data, f, indent=2)

# 7. 创建环境变量文件
env_content = """# 阿里云百炼配置
OPENAI_API_KEY=sk-8e72d53f10f9450baab69f89a2e2b992
OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
"""

with open(env_path, 'w') as f:
    f.write(env_content)

# 8. 输出配置摘要
print('\n' + '='*70)
print('✅ 阿里云百炼模型配置已更新')
print('='*70)
print(f"主模型: {data['agents']['defaults']['model']['primary']}")
print(f"备用模型: {data['agents']['defaults']['model']['fallbacks']}")
print(f"可用模型: {list(data['agents']['defaults']['models'].keys())}")
print('\n环境变量:')
print(f"OPENAI_API_KEY: sk-8e72d53f10f9450baab69f89a2e2b992")
print(f"OPENAI_BASE_URL: https://dashscope.aliyuncs.com/compatible-mode/v1")
print('\n下一步:')
print('1. 重启网关: clawdbot gateway stop; nohup clawdbot gateway --local --port 18789 --verbose &')
print('2. 测试配置: openclaw agent --agent main --message "测试" --local')
print('='*70)
EOF
```

### 2. 执行配置脚本

```bash
python3 setup_deepseek.py
```

---

## 方法二：使用 jq 命令注入配置

### 1. 安装 jq（如果未安装）

```bash
# CentOS/RHEL/OpenCloudOS
yum install -y jq

# 或使用 dnf
dnf install -y jq
```

### 2. 注入配置

```bash
# 备份原配置
cp ~/.openclaw/openclaw.json ~/.openclaw/openclaw.json.backup

# 注入配置
jq '
  .agents.defaults.model.primary = "openai/deepseek-v3.2" |
  .agents.defaults.model.fallbacks = ["openai/qwen-plus", "openai/qwen-max"] |
  .agents.defaults.models = {
    "openai/deepseek-v3.2": {},
    "openai/qwen-plus": {},
    "openai/qwen-max": {},
    "openai/gpt-4o": {}
  } |
  .models.providers.openai = {
    "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1"
  } |
  .plugins.entries["qwen-portal-auth"] = {"enabled": false}
' ~/.openclaw/openclaw.json > /tmp/openclaw_temp.json && mv /tmp/openclaw_temp.json ~/.openclaw/openclaw.json
```

### 3. 创建环境变量文件

```bash
cat > ~/.openclaw/.env << 'EOF'
# 阿里云百炼配置
OPENAI_API_KEY=sk-8e72d53f10f9450baab69f89a2e2b992
OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
EOF
```

---

## 方法三：手动编辑配置文件（简单直接）

### 1. 备份原配置

```bash
cp ~/.openclaw/openclaw.json ~/.openclaw/openclaw.json.backup
```

### 2. 编辑配置文件

```bash
nano ~/.openclaw/openclaw.json
# 或使用 vi
vi ~/.openclaw/openclaw.json
```

### 3. 修改以下部分

找到 `agents.defaults` 部分，修改为：

```json
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "openai/deepseek-v3.2",
        "fallbacks": [
          "openai/qwen-plus",
          "openai/qwen-max"
        ]
      },
      "models": {
        "openai/deepseek-v3.2": {},
        "openai/qwen-plus": {},
        "openai/qwen-max": {},
        "openai/gpt-4o": {}
      }
    }
  },
  "models": {
    "providers": {
      "openai": {
        "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1"
      }
    }
  },
  "plugins": {
    "entries": {
      "qwen-portal-auth": {
        "enabled": false
      }
    }
  }
}
```

### 4. 创建环境变量文件

```bash
cat > ~/.openclaw/.env << 'EOF'
# 阿里云百炼配置
OPENAI_API_KEY=sk-8e72d53f10f9450baab69f89a2e2b992
OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
EOF
```

---

## 使配置生效

### 1. 停止现有网关

```bash
# 方法一：使用命令停止
clawdbot gateway stop

# 方法二：手动杀死进程
pkill -f clawdbot-gateway

# 方法三：查找并杀死
ps aux | grep clawdbot
kill -9 <PID>
```

### 2. 设置环境变量（临时）

```bash
export OPENAI_API_KEY=sk-8e72d53f10f9450baab69f89a2e2b992
export OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
```

### 3. 启动网关

```bash
# 前台运行（查看日志）
clawdbot gateway --local --port 18789 --verbose

# 或后台运行
nohup clawdbot gateway --local --port 18789 --verbose > /tmp/gateway.log 2>&1 &
```

### 4. 验证配置

```bash
# 查看模型状态
openclaw models status

# 查看模型列表
openclaw models list

# 测试模型
openclaw agent --agent main --message "你好，测试一下" --local
```

---

## 验证配置是否成功

### 检查 1：查看模型列表

```bash
openclaw models list
```

**期望输出**：应该看到 `openai/deepseek-v3.2` 在列表中，并且标记为 `default`

### 检查 2：查看模型状态

```bash
openclaw models status
```

**期望输出**：
```
Default       : openai/deepseek-v3.2
Fallbacks (2) : openai/qwen-plus, openai/qwen-max
Configured models (4): openai/deepseek-v3.2, openai/qwen-plus, openai/qwen-max, openai/gpt-4o
```

### 检查 3：测试对话

```bash
openclaw agent --agent main --message "你好，请介绍一下你自己" --local
```

**期望结果**：应该收到 deepseek-v3.2 模型的回复

---

## 故障排除

### 问题 1：模型列表中没有显示 deepseek

**解决方案**：
```bash
# 检查配置文件语法
cat ~/.openclaw/openclaw.json | jq .

# 检查环境变量
echo $OPENAI_API_KEY
echo $OPENAI_BASE_URL

# 重新加载环境变量
source ~/.openclaw/.env
```

### 问题 2：认证错误

**解决方案**：
```bash
# 验证 API Key 是否正确
curl -X POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions \
  -H "Authorization: Bearer sk-8e72d53f10f9450baab69f89a2e2b992" \
  -H "Content-Type: application/json" \
  -d '{"model":"deepseek-v3.2","messages":[{"role":"user","content":"Hello"}]}'
```

### 问题 3：网关启动失败

**解决方案**：
```bash
# 检查端口占用
lsof -i :18789

# 查看详细日志
clawdbot gateway --local --port 18789 --verbose

# 检查配置文件
cat ~/.openclaw/openclaw.json
```

### 问题 4：qwen-portal 认证冲突

**解决方案**：
```bash
# 清理 qwen-portal 认证
rm -f ~/.openclaw/agents/main/agent/auth-profiles.json

# 重新运行配置脚本
python3 setup_deepseek.py
```

---

## 配置检查清单

在完成配置后，请确认以下项：

- [ ] 配置文件 `~/.openclaw/openclaw.json` 已更新
- [ ] 主模型设置为 `openai/deepseek-v3.2`
- [ ] 备用模型已配置
- [ ] 环境变量文件 `~/.openclaw/.env` 已创建
- [ ] `OPENAI_API_KEY` 已设置为 `sk-8e72d53f10f9450baab69f89a2e2b992`
- [ ] `OPENAI_BASE_URL` 已设置为 `https://dashscope.aliyuncs.com/compatible-mode/v1`
- [ ] qwen-portal-auth 插件已禁用
- [ ] 网关已重启
- [ ] 模型列表中显示 deepseek-v3.2
- [ ] 测试对话成功

---

## 快速命令汇总

```bash
# 一键配置（推荐使用 Python 脚本）
python3 setup_deepseek.py

# 停止网关
clawdbot gateway stop

# 启动网关
clawdbot gateway --local --port 18789 --verbose

# 查看模型状态
openclaw models status

# 测试对话
openclaw agent --agent main --message "测试" --local
```

---

**配置文件位置**：`deepseek_config.json`
**API Key**：`sk-8e72d53f10f9450baab69f89a2e2b992`
**模型名称**：`openai/deepseek-v3.2`
**API 端点**：`https://dashscope.aliyuncs.com/compatible-mode/v1`
