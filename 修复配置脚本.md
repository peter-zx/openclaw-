# 修复配置脚本

## 问题分析

错误信息：`models.providers.openai.models: Invalid input: expected array, received undefined`

这说明配置文件中 `models.providers.openai` 需要一个 `models` 数组字段。

## 解决方案

请在服务器上执行以下命令：

### 步骤 1：先查看当前配置文件结构

```bash
cat ~/.openclaw/openclaw.json | python3 -m json.tool
```

### 步骤 2：运行修复脚本

```bash
cat > ~/fix_deepseek_config.py << 'EOF'
#!/usr/bin/env python3
import json
import os

config_path = os.path.expanduser('~/.openclaw/openclaw.json')
env_path = os.path.expanduser('~/.openclaw/.env')

# 读取配置
with open(config_path, 'r') as f:
    data = json.load(f)

print('当前配置:')
print(f"主模型: {data['agents']['defaults']['model'].get('primary', '未设置')}")
print(f"备用模型: {data['agents']['defaults']['model'].get('fallbacks', [])}")

# 设置模型配置
data['agents']['defaults']['model']['primary'] = 'openai/deepseek-v3.2'
data['agents']['defaults']['model']['fallbacks'] = ['openai/qwen-plus', 'openai/qwen-max']
data['agents']['defaults']['models'] = {
    'openai/deepseek-v3.2': {},
    'openai/qwen-plus': {},
    'openai/qwen-max': {},
    'openai/gpt-4o': {}
}

# 配置 openai provider（包含 models 数组）
if 'models' not in data:
    data['models'] = {}
if 'providers' not in data['models']:
    data['models']['providers'] = {}

# 正确的 openai provider 配置
data['models']['providers']['openai'] = {
    'baseUrl': 'https://dashscope.aliyuncs.com/compatible-mode/v1',
    'models': []  # 添加 models 数组
}

# 禁用 qwen-portal-auth
if 'plugins' not in data:
    data['plugins'] = {}
if 'entries' not in data['plugins']:
    data['plugins']['entries'] = {}
data['plugins']['entries']['qwen-portal-auth'] = {'enabled': False}

# 清理 qwen-portal 认证
if 'auth' in data and 'profiles' in data['auth']:
    keys_to_remove = [k for k in data['auth']['profiles'] if k.startswith('qwen-portal:')]
    for k in keys_to_remove:
        del data['auth']['profiles'][k]
    if keys_to_remove:
        print(f'已移除 {len(keys_to_remove)} 个 qwen-portal auth profiles')

# 保存配置
with open(config_path, 'w') as f:
    json.dump(data, f, indent=2)

# 创建环境变量文件
with open(env_path, 'w') as f:
    f.write('OPENAI_API_KEY=sk-8e72d53f10f9450baab69f89a2e2b992\n')
    f.write('OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1\n')

print('\n' + '='*70)
print('✅ 阿里云百炼模型配置已更新')
print('='*70)
print(f"主模型: {data['agents']['defaults']['model']['primary']}")
print(f"备用模型: {data['agents']['defaults']['model']['fallbacks']}")
print(f"可用模型: {list(data['agents']['defaults']['models'].keys())}")
print('\n环境变量:')
print(f"OPENAI_API_KEY: sk-8e72d53f10f9450baab69f89a2e2b992")
print(f"OPENAI_BASE_URL: https://dashscope.aliyuncs.com/compatible-mode/v1")
print('='*70)
EOF

python3 ~/fix_deepseek_config.py
```

---

### 步骤 3：验证配置文件

```bash
# 检查配置文件语法
cat ~/.openclaw/openclaw.json | python3 -m json.tool

# 检查 openai provider 配置
cat ~/.openclaw/openclaw.json | grep -A 5 '"openai"'
```

---

### 步骤 4：停止网关

```bash
clawdbot gateway stop
```

---

### 步骤 5：加载环境变量并启动网关

```bash
# 加载环境变量
source ~/.openclaw/.env
export OPENAI_API_KEY=sk-8e72d53f10f9450baab69f89a2e2b992
export OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1

# 启动网关
clawdbot gateway --local --port 18789 --verbose
```

---

### 步骤 6：验证配置（新开终端）

```bash
# 查看模型状态
openclaw models status

# 查看模型列表
openclaw models list

# 测试对话
openclaw agent --agent main --message "你好，测试一下" --local
```

---

## 如果还有问题，使用 doctor 修复

```bash
# 运行配置诊断和修复
openclaw doctor --fix

# 查看诊断结果
openclaw doctor
```

---

## 手动修复方法（如果脚本不工作）

如果脚本还有问题，可以手动编辑配置文件：

```bash
# 备份配置
cp ~/.openclaw/openclaw.json ~/.openclaw/openclaw.json.backup

# 编辑配置文件
vi ~/.openclaw/openclaw.json
```

找到 `models.providers.openai` 部分，确保包含 `models` 数组：

```json
{
  "models": {
    "providers": {
      "openai": {
        "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "models": []
      }
    }
  }
}
```

保存后执行：

```bash
# 验证配置
cat ~/.openclaw/openclaw.json | python3 -m json.tool

# 重启网关
clawdbot gateway stop
source ~/.openclaw/.env
clawdbot gateway --local --port 18789 --verbose
```
